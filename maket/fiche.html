<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Création fiche — Tags contrôlés</title>
  <style>
    :root{
      --sidebar-bg:#1e293b;
      --accent:#2563eb;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e6eef8;
      --muted:#6b7280;
      --text:#111827;
      --tag-bg:#eef6ff;
      --tag-border:#dbeffd;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
      display:flex;
      height:100vh;
      background:var(--bg);
      color:var(--text);
    }

    /* SIDEBAR */
    .sidebar{
      width:220px;
      background:var(--sidebar-bg);
      color:#f1f5f9;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{font-weight:600;font-size:1.05rem;margin-bottom:8px}
    .nav button{
      background:none;border:0;color:#e6eef8;text-align:left;padding:8px;border-radius:6px;cursor:pointer;
    }
    .nav button.active{background:var(--accent);color:#fff}

    /* MAIN */
    .main{flex:1;padding:28px;overflow:auto}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .head h1{margin:0;font-size:1.25rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px;max-width:920px;box-shadow:0 1px 4px rgba(15,23,42,0.03)}
    form{display:flex;flex-direction:column;gap:14px}

    label{font-weight:600;font-size:0.90rem;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], textarea, select{
      width:100%;padding:10px;border-radius:8px;border:1px solid #d6e4f3;background:#fff;font-size:0.95rem;color:var(--text)
    }
    textarea{min-height:120px;resize:vertical}

    /* Tags UI */
    .tags-input{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .tag-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--tag-bg);border:1px solid var(--tag-border);font-size:0.9rem;color:var(--text)}
    .tag-remove{background:transparent;border:0;color:var(--muted);cursor:pointer;font-weight:700}

    .tag-picker-btn{margin-left:auto;background:transparent;border:1px solid var(--border);padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--accent)}
    .tag-panel{
      position:relative;
    }
    .tag-dropdown{
      position:absolute;left:0;top:10px;width:760px;max-width:calc(100vw - 120px);background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;box-shadow:0 8px 20px rgba(15,23,42,0.08);z-index:80
    }
    .tag-search{display:flex;gap:8px;margin-bottom:10px}
    .tag-search input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)}
    .tag-list{display:flex;gap:16px}
    .tag-col{min-width:180px;max-width:320px}
    .tag-col h4{margin:0 0 8px 0;font-size:0.9rem;color:var(--muted)}
    .tag-item{display:inline-flex;align-items:center;gap:8px;margin:6px 6px 0 0;padding:6px 8px;border-radius:8px;background:#fbfeff;border:1px solid #eef8ff;font-size:0.9rem;cursor:pointer;color:var(--text)}
    .tag-item.selected{background:var(--accent);color:#fff;border-color:transparent}
    .tag-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .muted{color:var(--muted);font-size:0.9rem}

    /* actions */
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
    .btn{padding:8px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.secondary{background:#eef2f7;color:var(--text)}
    .btn.primary{background:var(--accent);color:#fff}

    /* responsive */
    @media (max-width:900px){
      .tag-dropdown{width:calc(100vw - 40px)}
      .tag-list{flex-direction:column}
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">Tuilage IT — Draft</div>
    <nav class="nav">
      <button>Tableau de bord</button>
      <button class="active">Nouvelle fiche</button>
      <button>Fiches</button>
      <button>Checklists</button>
      <button>Inventaire</button>
    </nav>
    <div style="margin-top:auto;font-size:0.85rem;color:#cfe0ff">Utilisateur : Erwin M.</div>
  </aside>

  <main class="main">
    <div class="head">
      <h1>Nouvelle fiche — Configuration / procédure</h1>
      <div class="muted">Rubrique contextuelle : Infrastructure › Pare-feu</div>
    </div>

    <div class="card">
      <form id="ficheForm" autocomplete="off" onsubmit="return false;">
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label for="titre">Titre</label>
            <input id="titre" type="text" placeholder="Ex : Configuration VPN SSL Fortinet">
          </div>
          <div style="width:160px">
            <label for="categorie">Catégorie visible</label>
            <select id="categorie">
              <option>Infrastructure</option>
              <option>Systèmes & Serveurs</option>
              <option>Postes & Périphériques</option>
              <option>Téléphonie</option>
              <option>Sécurité</option>
              <option>Support</option>
              <option>Administration</option>
            </select>
          </div>
          <div style="width:140px">
            <label for="etat">État de la fiche</label>
            <select id="etat">
              <option>À faire</option>
              <option>En cours</option>
              <option>Terminé</option>
            </select>
          </div>
        </div>
      <div>
        <label for="description">Description / Procédure (Markdown)</label>
        <div style="display:flex;gap:12px;flex-direction:column">
          <textarea id="description" placeholder="Décris la procédure, les accès, captures, remarques..." style="min-height:160px"></textarea>
          <div id="mdPreview" style="padding:12px;border:1px solid var(--border);border-radius:8px;background:#fbfcfd;font-size:0.95rem;line-height:1.5;display:none"></div>
        </div>
      </div>
        <div>
          <label>Tags (sélection contrôlée)</label>
          <div class="tags-input" id="selectedTags">
            <span class="muted" id="noTagNotice">Aucun tag sélectionné</span>
            <button type="button" class="tag-picker-btn" id="openTagPicker">Sélectionner des tags ▾</button>
          </div>

          <!-- tag dropdown panel -->
          <div class="tag-panel" id="tagPanelRoot" style="position:relative">
            <div id="tagDropdown" class="tag-dropdown" style="display:none;margin-top:8px">
              <div class="tag-search">
                <input id="tagSearch" placeholder="Rechercher un tag (ex: Veeam, Sauvegarde, Fortinet)">
                <button type="button" class="btn secondary" id="clearSearch">Effacer</button>
              </div>

              <div class="tag-list" id="tagListRoot">
                <!-- columns injected by JS -->
              </div>

              <div class="tag-footer">
                <div class="muted" id="tagCount">0 sélectionné(s)</div>
                <div>
                  <button type="button" class="btn secondary" id="cancelTags">Annuler</button>
                  <button type="button" class="btn primary" id="applyTags">Appliquer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <label for="contacts">Contacts / Référents</label>
            <input id="contacts" type="text" placeholder="Ex : Jean Dupont — admin@entreprise.fr">
          </div>
          <div style="width:220px">
            <label for="priorite">Criticité</label>
            <select id="priorite">
              <option>Standard</option>
              <option>Important</option>
              <option>Critique</option>
              <option>À surveiller</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn secondary" id="discard">Annuler</button>
          <button type="submit" class="btn primary" id="saveBtn">Enregistrer la fiche</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    // Taxonomie (prédéfinie, contrôlée)
    const TAGS = {
      "Domaine": ["Infrastructure","Réseau","Systèmes","Serveurs","Postes de travail","Périphériques","Téléphonie","Sécurité","Audiovisuel","Administration","Support","Checklist"],
      "Thème": ["Schéma réseau","VLAN","Pare-feu","Virtualisation","Stockage","Sauvegarde","Active Directory","DNS","Messagerie","Base de données","Télémaintenance","Impression","Inventaire","Contrôle d’accès","Vidéosurveillance","Procédure d’incident","RGPD","Formation","Contrat","Commande","Budget","Veille technologique"],
      "Technologie": ["Fortinet","Veeam","vSphere","Windows Server","Exchange","Outlook","Access","SQL","Alcatel","VOIP","Ricoh","TeamViewer","AnyDesk","Synology","Office 365","ESXi"],
      "Type": ["Procédure","Configuration","Incident","Diagnostic","Inventaire","Plan","Check-list","Contact","Contrat","Note interne","À valider","Obsolète"]
    };

    const maxColumns = Object.keys(TAGS).length;
    const selected = new Set();

    // UI refs
    const openBtn = document.getElementById('openTagPicker');
    const tagDropdown = document.getElementById('tagDropdown');
    const tagListRoot = document.getElementById('tagListRoot');
    const tagSearch = document.getElementById('tagSearch');
    const clearSearch = document.getElementById('clearSearch');
    const applyTags = document.getElementById('applyTags');
    const cancelTags = document.getElementById('cancelTags');
    const selectedTagsRoot = document.getElementById('selectedTags');
    const tagCount = document.getElementById('tagCount');
    const noTagNotice = document.getElementById('noTagNotice');

    // render columns
    function renderTagColumns(filter=''){
      tagListRoot.innerHTML = '';
      const filterLower = filter.trim().toLowerCase();
      for(const [colName, items] of Object.entries(TAGS)){
        const col = document.createElement('div');
        col.className = 'tag-col';
        const h = document.createElement('h4');
        h.textContent = colName;
        col.appendChild(h);

        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.flexWrap = 'wrap';

        items.forEach(tag => {
          if(filterLower && !tag.toLowerCase().includes(filterLower)) return;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'tag-item' + (selected.has(tag) ? ' selected' : '');
          btn.textContent = tag;
          btn.onclick = () => toggleTagUI(tag, btn);
          wrap.appendChild(btn);
        });

        col.appendChild(wrap);
        tagListRoot.appendChild(col);
      }
      updateTagCount();
    }

    function toggleTagUI(tag, el){
      if(selected.has(tag)){
        selected.delete(tag);
        el.classList.remove('selected');
      } else {
        selected.add(tag);
        el.classList.add('selected');
      }
      updateTagCount();
    }

    function updateTagCount(){
      tagCount.textContent = `${selected.size} sélectionné(s)`;
    }

    function openPicker(){
      tagDropdown.style.display = 'block';
      tagSearch.value = '';
      renderTagColumns();
      setTimeout(()=> tagSearch.focus(),50);
    }
    function closePicker(){
      tagDropdown.style.display = 'none';
    }

    function refreshSelectedBadges(){
      selectedTagsRoot.querySelectorAll('.tag-badge').forEach(n=>n.remove());
      const picker = document.getElementById('openTagPicker');
      if(selected.size === 0){
        noTagNotice.style.display = 'inline';
      } else {
        noTagNotice.style.display = 'none';
      }
      for(const t of selected){
        const span = document.createElement('span');
        span.className = 'tag-badge';
        span.textContent = t;
        const rem = document.createElement('button');
        rem.className = 'tag-remove';
        rem.type = 'button';
        rem.innerHTML = '✕';
        rem.title = 'Retirer ce tag';
        rem.onclick = ()=>{ selected.delete(t); refreshSelectedBadges(); renderTagColumns(tagSearch.value); updateTagCount(); };
        span.appendChild(rem);
        selectedTagsRoot.insertBefore(span, picker);
      }
    }

    openBtn.addEventListener('click', openPicker);
    clearSearch.addEventListener('click', ()=>{ tagSearch.value=''; renderTagColumns(); });
    tagSearch.addEventListener('input', ()=> renderTagColumns(tagSearch.value));
    cancelTags.addEventListener('click', ()=>{ closePicker(); });
    applyTags.addEventListener('click', ()=>{
      refreshSelectedBadges();
      closePicker();
    });

    document.addEventListener('click', (e)=>{
      if(!document.getElementById('tagPanelRoot').contains(e.target) && !openBtn.contains(e.target)){
        if(tagDropdown.style.display === 'block') closePicker();
      }
    });

    renderTagColumns();
    updateTagCount();

    document.getElementById('saveBtn').addEventListener('click', ()=>{
      const payload = {
        titre: document.getElementById('titre').value.trim(),
        categorie: document.getElementById('categorie').value,
        etat: document.getElementById('etat').value,
        description: document.getElementById('description').value.trim(),
        contacts: document.getElementById('contacts').value.trim(),
        priorite: document.getElementById('priorite').value,
        tags: Array.from(selected)
      };
      if(!payload.titre){ alert('Le titre est requis'); return; }
      console.log('Payload fiche:', payload);
      alert('Fiche prête à être enregistrée (voir console)');
    });

    document.getElementById('discard').addEventListener('click', ()=>{ if(confirm('Annuler la création ?')) location.reload(); });
  </script>
</body>
</html>